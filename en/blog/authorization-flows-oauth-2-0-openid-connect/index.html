<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Authorization flows with OAuth 2.0 and OpenID Connect | Rafael Neto</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#d66056">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-S8PRT356B6"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-S8PRT356B6', { 'anonymize_ip': true });</script>
    <link rel="alternate" type="application/rss+xml" href="https://rafaelneto.dev/rss.xml" title="Rafael Neto RSS Feed">
    <meta name="description" content="An authorization flow is what allows a client application such as web applications, desktop applications, mobile phones, IoT devices, and other consumers to gain authorized access ...">
    <meta property="article:published_time" content="2023-02-28T00:00:00.000Z">
    <meta property="og:site_name" content="Rafael Neto">
    <meta property="og:title" content="Authorization flows with OAuth 2.0 and OpenID Connect">
    <meta property="og:description" content="An authorization flow is what allows a client application such as web applications, desktop applications, mobile phones, IoT devices, and other consumers to gain authorized access ...">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/en/blog/authorization-flows-oauth-2-0-openid-connect/">
    <meta name="twitter:title" content="Authorization flows with OAuth 2.0 and OpenID Connect">
    <meta name="twitter:description" content="An authorization flow is what allows a client application such as web applications, desktop applications, mobile phones, IoT devices, and other consumers to gain authorized access ...">
    <meta name="twitter:url" content="/en/blog/authorization-flows-oauth-2-0-openid-connect/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="ASPNETCore, AzureAD, OAuth2, OIDC, security">
    <meta property="article:tag" content="ASPNETCore">
    <meta name="theme-color" content="#d66056">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/images/icons/icon-144x144">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.bb0c19ce.css" as="style"><link rel="preload" href="/assets/js/app.ee019d85.js" as="script"><link rel="preload" href="/assets/js/4.35e6b205.js" as="script"><link rel="preload" href="/assets/js/1.801c1b6e.js" as="script"><link rel="preload" href="/assets/js/34.70cab748.js" as="script"><link rel="prefetch" href="/assets/js/11.7f50e1d9.js"><link rel="prefetch" href="/assets/js/12.e5fcd202.js"><link rel="prefetch" href="/assets/js/13.89648ad6.js"><link rel="prefetch" href="/assets/js/14.c6a608cd.js"><link rel="prefetch" href="/assets/js/15.00d4c987.js"><link rel="prefetch" href="/assets/js/16.f0891c93.js"><link rel="prefetch" href="/assets/js/17.93778a3e.js"><link rel="prefetch" href="/assets/js/18.1468113e.js"><link rel="prefetch" href="/assets/js/19.40f9e796.js"><link rel="prefetch" href="/assets/js/2.ff0695d0.js"><link rel="prefetch" href="/assets/js/20.7c41a12f.js"><link rel="prefetch" href="/assets/js/21.fc80806c.js"><link rel="prefetch" href="/assets/js/22.40f1a2c2.js"><link rel="prefetch" href="/assets/js/23.099cf4dd.js"><link rel="prefetch" href="/assets/js/24.27062614.js"><link rel="prefetch" href="/assets/js/25.db00c68a.js"><link rel="prefetch" href="/assets/js/26.75eced52.js"><link rel="prefetch" href="/assets/js/27.141748c3.js"><link rel="prefetch" href="/assets/js/28.4a2b2f52.js"><link rel="prefetch" href="/assets/js/29.f700ec1a.js"><link rel="prefetch" href="/assets/js/3.51e60054.js"><link rel="prefetch" href="/assets/js/30.303c9639.js"><link rel="prefetch" href="/assets/js/31.61e0e098.js"><link rel="prefetch" href="/assets/js/32.2e93f8ac.js"><link rel="prefetch" href="/assets/js/33.7197ed8c.js"><link rel="prefetch" href="/assets/js/35.a2938760.js"><link rel="prefetch" href="/assets/js/36.344d5f62.js"><link rel="prefetch" href="/assets/js/37.ccd6ef99.js"><link rel="prefetch" href="/assets/js/38.f747c3ac.js"><link rel="prefetch" href="/assets/js/39.0014b129.js"><link rel="prefetch" href="/assets/js/40.4bcb8f39.js"><link rel="prefetch" href="/assets/js/41.54d85b43.js"><link rel="prefetch" href="/assets/js/42.8116cd4c.js"><link rel="prefetch" href="/assets/js/43.6f3e70fc.js"><link rel="prefetch" href="/assets/js/44.d6d8abff.js"><link rel="prefetch" href="/assets/js/45.cd9babd6.js"><link rel="prefetch" href="/assets/js/46.cb867dfa.js"><link rel="prefetch" href="/assets/js/47.070d730e.js"><link rel="prefetch" href="/assets/js/48.0cdf0dc3.js"><link rel="prefetch" href="/assets/js/49.3c348071.js"><link rel="prefetch" href="/assets/js/5.d96a2b8c.js"><link rel="prefetch" href="/assets/js/50.70221375.js"><link rel="prefetch" href="/assets/js/51.4d3bfe99.js"><link rel="prefetch" href="/assets/js/52.290b62dd.js"><link rel="prefetch" href="/assets/js/53.bdead276.js"><link rel="prefetch" href="/assets/js/54.af6c538d.js"><link rel="prefetch" href="/assets/js/55.7aa7f892.js"><link rel="prefetch" href="/assets/js/56.fd25720a.js"><link rel="prefetch" href="/assets/js/57.dd9ffee0.js"><link rel="prefetch" href="/assets/js/58.a9fa94d5.js"><link rel="prefetch" href="/assets/js/59.b24205ab.js"><link rel="prefetch" href="/assets/js/6.fff243bb.js"><link rel="prefetch" href="/assets/js/60.c48f9f3c.js"><link rel="prefetch" href="/assets/js/61.6ae343dc.js"><link rel="prefetch" href="/assets/js/62.d5032578.js"><link rel="prefetch" href="/assets/js/63.0566b7b0.js"><link rel="prefetch" href="/assets/js/64.39f75b2c.js"><link rel="prefetch" href="/assets/js/65.cafbd489.js"><link rel="prefetch" href="/assets/js/66.d2dbf74b.js"><link rel="prefetch" href="/assets/js/67.08618c54.js"><link rel="prefetch" href="/assets/js/68.161678f2.js"><link rel="prefetch" href="/assets/js/69.788810b6.js"><link rel="prefetch" href="/assets/js/7.170b11d7.js"><link rel="prefetch" href="/assets/js/70.fbb3b202.js"><link rel="prefetch" href="/assets/js/71.a3d8b7aa.js"><link rel="prefetch" href="/assets/js/72.46d6c318.js"><link rel="prefetch" href="/assets/js/73.e99efe3a.js"><link rel="prefetch" href="/assets/js/74.fd9eaff7.js"><link rel="prefetch" href="/assets/js/75.6782e97d.js"><link rel="prefetch" href="/assets/js/76.06524762.js"><link rel="prefetch" href="/assets/js/77.aec65f81.js"><link rel="prefetch" href="/assets/js/78.d7ce09bc.js"><link rel="prefetch" href="/assets/js/79.28e1de1e.js"><link rel="prefetch" href="/assets/js/8.13e5b4ae.js"><link rel="prefetch" href="/assets/js/80.917ff461.js"><link rel="prefetch" href="/assets/js/81.745e410a.js"><link rel="prefetch" href="/assets/js/82.9ef78695.js"><link rel="prefetch" href="/assets/js/83.a4ce6c69.js"><link rel="prefetch" href="/assets/js/84.5c274b85.js"><link rel="prefetch" href="/assets/js/85.1991c579.js"><link rel="prefetch" href="/assets/js/86.bdab760b.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.8d41f623.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bb0c19ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Rafael Neto </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/en/blog/" class="nav-link router-link-active">English</a></li><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Rafael Neto </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/en/blog/" class="nav-link router-link-active">English</a></li><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2023-2-28">
      2023-02-28
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/ASPNETCore" data-v-42ccfcd5><span data-v-42ccfcd5>ASPNETCore</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/AzureAD" data-v-42ccfcd5><span data-v-42ccfcd5>AzureAD</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/OAuth2" data-v-42ccfcd5><span data-v-42ccfcd5>OAuth2</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/OIDC" data-v-42ccfcd5><span data-v-42ccfcd5>OIDC</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/security" data-v-42ccfcd5><span data-v-42ccfcd5>security</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="authorization-flows-with-oauth-2-0-and-openid-connect"><a href="#authorization-flows-with-oauth-2-0-and-openid-connect" class="header-anchor">#</a> Authorization flows with OAuth 2.0 and OpenID Connect</h1> <!----> <p><a href="/blog/flujos-autorizacion-oauth-2-0-openid-connect/">Español</a> | English</p> <p>An authorization flow is what allows a client application such as web applications, desktop applications, mobile phones, IoT devices, and other consumers to gain authorized access to protected resources such as web APIs and files, among others. OAuth 2.0 focuses on simplicity for the client developer while providing specific authorization flows, which are enriched by using OpenID Connect as a simple identity layer on top of the OAuth 2.0 protocol.</p> <h2 id="oauth-2-0"><a href="#oauth-2-0" class="header-anchor">#</a> OAuth 2.0</h2> <p>OAuth 2.0 is a standard authorization framework that allows greater control over the scope of an application and authorization flows across multiple systems. OAuth 2.0 is all about access to resources with granular scopes that grant you permissions on behalf of a user.</p> <p>Before OpenID Connect, OAuth 2.0 was used for authentication and authorization, but the problem was that with OAuth we didn´t have the user information because OAuth don't cares who you are. OAuth was designed for permission and scopes, but there were a lot of companies (Facebook, Google, Twitter, etc) using OAuth 2.0 for their authentication process. All of them needed to create a customized implementation to supply the protocol lacks related to user identification (and that's why some documentation confuses us).</p> <p>OAuth 2.0 was used for delegate authorization as well as overused for authentication with simple login, SSO and login on mobile apps.</p> <h2 id="openid-connect-oidc"><a href="#openid-connect-oidc" class="header-anchor">#</a> OpenID Connect (OIDC)</h2> <p>OpenID Connect is an extra identity layer (an extension) on top of OAuth 2.0 protocol by using the standarized OAuth 2.0 message flow based on JSON and HTTP, to provide a new identity services protocol for authentication, which allows applications to verify and receive the user profile information of signed-in users.</p> <blockquote><p>OAuth 2.0 + Identity + Authentication = <strong>OpenID Connect</strong></p></blockquote> <p>OpenID Connect adds OAuth 2.0:</p> <ul><li>ID token which represents some user information.</li> <li>Endpoints for verifying the identity information and getting more user information.</li> <li>Standard scopes and claims specifically for identity.</li> <li>Standarized implementation.</li> <li>A discovery document where the server publishes its metadata through the well-know URL (<em>https://my-iodc-server.com/.well-known/openid-configuration</em>).</li></ul> <p>OpenID Connect lets developers to relieve themselves of the difficult and dangerous responsability of storing and managing people's passwords, it also identifies personal attributes that can be exchanged between Identity Providers and the applications that use them, and includes an approval step in which the user can consent or deny the exchange of this information.</p> <p>Therefore, we should use OAuth 2.0 for authorization, that is, granting access to APIs and getting access to user data in other systems, and OpenID Connect for authentication, that is, logging the user and for making a user available in other system.</p> <h3 id="implementations-of-openid-connect"><a href="#implementations-of-openid-connect" class="header-anchor">#</a> Implementations of OpenID Connect</h3> <p><a href="https://openid.net/developers/certified/" target="_blank" rel="noopener noreferrer">Libraries, servers, services and providers with certified implementations of OpenID Connect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="key-concepts"><a href="#key-concepts" class="header-anchor">#</a> Key concepts</h3> <ul><li><em>Client ID</em>: Identifies the client (application) at the authorization server.</li> <li><em>Client secret</em>: The password/private key that only the client and de authorization server know.</li> <li><em>Authorization code</em>: Is a temporary code returned by the authentication server and used with the client secret by the application to exchange for the access token and the ID token.</li> <li><em>Access token</em>: It is the key the client will use to request data from the resource server.</li> <li><em>ID token</em>: It is the user profile information returned securely by the authentication server in JWT format. Could be extended calling the <em>user_info</em> endpoint and must be checked by client to ensure that the <em>aud</em> (audience, i.e. client) matches its <em>client_id</em> and <em>iss</em> (issuing authority) matches the domain (or sub-domain) of the issuer of the <em>client_id</em>.</li> <li><em>Access token</em>: It is an OAuth string used in a token-based authorization system to make requests to allow an application to access an API or resource server. They are the ones that are used as <em>Bearer tokens</em>.</li> <li><em>Refresh token</em>: It's a special token returned during the authentication code exchange and provides to the client the possibility to have continuous access to the resources while the user is not using the application. It allows an application to obtain a new access token without prompting the user via the refresh token flow. When used in the front channel to refresh the access token, it's protected by a HTTP Only cookies or using a new technique called <em>Refresh Token Rotation</em> where a new refresh token is generated with each request. <em>A refresh token can compromise the app security allowing someone connect to the system.</em></li> <li><em>Scopes</em>: Token access grants access to do specific things and scopes is the way of define with a granular way, how the client (application) requests that access (read email, write email, delete photo, etc). Is the mechanism used to limit the access to a user's data from a application.</li> <li><em>opendid</em> scope: With this scope, the OAuth 2.0 request, turns into an OpenID Connect request. It means that the client is requesting an identifier (<em>id</em>) for the user. Others importants OpenID Connect scopes are:
<ul><li><em>profile</em>: returns the profile information (defined by the server and the user) as first name, last name or picture.</li> <li><em>email</em>: returns the user email.</li> <li><em>address</em>: the user address.</li> <li><em>phone</em>: the user phone.</li></ul></li></ul> <h3 id="openid-connect-authorization-code-flow"><a href="#openid-connect-authorization-code-flow" class="header-anchor">#</a> OpenID Connect Authorization Code Flow</h3> <p>The Authorization Code Flow is an OpenID Connect flow (based on the OAuth 2.0 Authorization Code Flow that is extended with OIDC features) specifically designed to authenticate server-side applications since a key exchange must take place in a secure environment (back channel).</p> <h4 id="how-does-it-work"><a href="#how-does-it-work" class="header-anchor">#</a> How does it work?</h4> <ol><li>The user click the login link that trigger an action on the app server-side (back channel).</li> <li>The app server-side requests an authorization <em>code</em> to the authorization server through the <em>authorize</em> endpoint. The request includes the <em>openid</em> scope in addition to other scopes, the <em>client id</em>, the <em>state</em> parameter (value used to maintain state between the request and the response) and indicates that requiere the response type <em>code</em>.</li> <li>The authorization server redirects the user to the login page.</li> <li>The user authenticate and consents (or denies) the requested scopes.</li> <li>If the user grants access to the app, the authorization server response an <em>authorization code</em> and the <em>state</em> to the app server-side.</li> <li>The app server-side requests the exchange of the <em>access token</em> and the <em>id token</em> (optionally a <em>refresh token</em>) to the authentication server through the <em>token</em> endpoint, using the original <em>authorization code</em>, the <em>client id</em> and the <em>client secret</em>.</li> <li>The authorization server verifies the request.</li> <li>The authorization server responds with an <em>access token</em> and an <em>id token</em> (optionally a <em>refresh token</em>) to the app server-side.</li> <li>At this step, the app can create an user session or register the new user in the app using the user profile information.</li> <li>The app server-side makes calls to the API using the <em>access token</em> using the authorization <em>Bearer</em> in the HTTP header.</li> <li>The API responds with data to the app server-side.</li></ol> <h3 id="authorization-code-flow-with-pkce"><a href="#authorization-code-flow-with-pkce" class="header-anchor">#</a> Authorization Code Flow with PKCE</h3> <p>To avoid authorization code interception attack we can use PKCE that extends the authorization code flow preventing <a href="https://developer.mozilla.org/en-US/docs/Glossary/CSRF" target="_blank" rel="noopener noreferrer">CSRF<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. PKCE, pronounced “pixy” is an acronym for <em>Proof Key for Code Exchange</em>. This flow includes new PKCE elements (<em>code verifier</em>, <em>code challenge</em> and <em>code challenge method</em>) at various steps in the flow in charge of protecting the communication between the client and the authentication server.</p> <p>It was original designed to protect the authorization code flow in mobile apps where we cannot securely store a client secret, but currently it is the <strong>recommended flow for most applications</strong> like web application with server backend, SPAs with and without backend, native and mobile apps.</p> <h4 id="how-does-it-work-2"><a href="#how-does-it-work-2" class="header-anchor">#</a> How does it work?</h4> <ol><li>The user click the login link.</li> <li>The client/app (client-side/front channel or server-side/back channel), creates a cryptographically randomized <em>code verifier</em> and from there it generates a <em>code challenge</em>.</li> <li>The client requests an authorization <em>code</em> to the authorization server through the <em>authorize</em> endpoint. The request includes the <em>code challenge</em> and the <em>state</em> parameter (value used to maintain state between the request and the response).</li> <li>The authorization server redirects the user to the login page.</li> <li>The user authenticate and consents (or denies) the requested scopes.</li> <li>If the user grants access to the app, the authorization server stores the <em>code challenge</em> and response an <em>authorization code</em> the app.</li> <li>The app requests the exchange of the <em>access token</em> and the <em>id token</em> (optionally a <em>refresh token</em>) to the authentication server through the <em>token</em> endpoint, using the original <em>authorization code</em> and the <em>code verifier</em>.</li> <li>The authorization server verifies the <em>code challenge</em> and <em>code verifier</em>.</li> <li>The authorization server responds with an <em>access token</em> and an <em>id token</em> (optionally a <em>refresh token</em>) to the app.</li> <li>At this step, the app can create an user session or register the new user in the app using the user profile information.</li> <li>The app makes calls to the API using the <em>access token</em> using the authorization <em>Bearer</em> in the HTTP header.</li> <li>The API responds with data.</li></ol> <p>OAuth 2.0 Authorization Code Flow with PKCE (as well as the Authorization Code Flow from which it derives), allows you to authenticate on behalf of another user to have more control over an application’s scopes and improves authorization flows across multiple devices. In other words, developers building applications for people on Twitter, GitHub, AWS, Google or PayPal for example, will have more control over the information their app requests from its users, so that you only have to ask (through the scopes) your end-users for the data and information you need.</p> <blockquote><p>This modern authorization protocol will allow you to present your end-users with a more streamlined consent flow for authorizing your app, which only displays the specific scopes you have requested from them. Not only does this reduce your data burden, but it may also lead to increased trust from end-users. This flow is used to grant access to an API or getting access to user data in other systems and when you grants an application to import your user information from another application.</p></blockquote> <h3 id="implicit-flow"><a href="#implicit-flow" class="header-anchor">#</a> Implicit Flow</h3> <p>The legacy flow used only for SPAs that do not have a back-channel and cannot support PKCE, therefore it is less secure and much simpler.</p> <h4 id="how-does-it-work-3"><a href="#how-does-it-work-3" class="header-anchor">#</a> How does it work?</h4> <ol><li>The user click the login link that trigger an action on the app (front channel).</li> <li>The app requests the <em>id token</em> to the authorization server through the <em>authorize</em> endpoint. The request includes the <em>openid</em> scope in addition to other scopes and the <em>client id</em>, the <em>state</em> parameter (value used to maintain state between the request and the response), the <em>redirect_uri</em> where the app will listen for the callback, and indicates that requiere the response type <em>id_token</em> (to get the only the <em>id_token</em>) or <em>id_token token</em> (to get the <em>id_token</em> and the <em>access_token</em>).</li> <li>The authorization server redirects the user to the login page.</li> <li>The user authenticate and consents (or denies) the requested scopes.</li> <li>If the user grants access to the app, the authorization server redirect to the app with an <em>id token</em> and an <em>access token</em> (if requested) and the client validates the token.</li> <li>At this step, the app can makes calls to the API using the <em>access token</em> using the authorization <em>Bearer</em> in the HTTP header.</li> <li>The API responds with data to the SPA.</li></ol> <h3 id="client-credentials-flow"><a href="#client-credentials-flow" class="header-anchor">#</a> Client Credentials Flow</h3> <p>The client credentials flow is used in the context of machine to machine communication (back-end) and using a secret key that only the system knows to authenticate and authorize the applications in the background instead of a user.</p> <h4 id="how-does-it-work-4"><a href="#how-does-it-work-4" class="header-anchor">#</a> How does it work?</h4> <ol><li>The app requests the <em>access token</em> to the authorization server through the <em>token</em> endpoint, using the <em>client id</em> and the <em>client secret</em>.</li> <li>The authorization server verifies the request.</li> <li>The authorization server responds with an <em>access token</em> to the app.</li> <li>The app makes calls to the API using the <em>access token</em> using the authorization <em>Bearer</em> in the HTTP header.</li> <li>The API responds with data to the app.</li></ol> <h2 id="connecting-authorization-server-users-and-the-application-users"><a href="#connecting-authorization-server-users-and-the-application-users" class="header-anchor">#</a> Connecting authorization server users and the application users</h2> <p>One possible way to connect authorization server users and application users is when the application has a user data store. In that case we can handle the connecting between both with a claim (maybe the user's email). The use case could be:</p> <ol><li>As a previous step, you could create the user in the application.</li> <li>When the user authenticates through the identity server, use a claim to match with the user's application data.</li> <li>If the user was not created before, register the new user in the application using the user profile information.</li> <li>Create a user session and allow the application using.</li></ol> <p>This approach enables the possibility of using multiple authentication servers.</p> <p>Another way is when we don't have a user table. In that case we need to trust in the authentication server system and handle it using the user profile, scopes, and claims directly.</p> <blockquote><p><em>How can we use the refresh token to keep a web session alive?</em> The best way to handle with that is redirect back the user to the authentication server and let the authorization server keep track the session for the user.</p></blockquote> <h2 id="secure-application-with-openid-connect-and-azure-ad"><a href="#secure-application-with-openid-connect-and-azure-ad" class="header-anchor">#</a> Secure application with OpenID Connect and Azure AD</h2> <h3 id="what-is-azure-active-directory"><a href="#what-is-azure-active-directory" class="header-anchor">#</a> What is Azure Active Directory?</h3> <p>Azure Active Directory (Azure AD) is Microsoft's cloud-based identity and access management service (authentication provider). It simplifies authentication for developers by providing identity as a service. It supports industry-standard protocols such as OAuth 2.0 and OpenID Connect.</p> <h2 id="create-an-azure-ad-tenant"><a href="#create-an-azure-ad-tenant" class="header-anchor">#</a> Create an Azure AD tenant</h2> <p>A tenant is an instance of Azure AD that represents an organization. It's a dedicated instance of Azure AD that an organization or app developer receives when the organization or app developer creates a relationship with Microsoft, like signing up for Azure, Microsoft 365, or Microsoft Intune.</p> <h2 id="register-a-web-app"><a href="#register-a-web-app" class="header-anchor">#</a> Register a web app</h2> <p>Within the Azure AD tenant, you'll need a registration for the application. The registration is a record of security details for the application in Azure AD. A registration ensures that Azure AD can identify the application and the user. An app registration can includes support for organizational directory and Microsoft accounts.</p> <h2 id="configure-the-app-for-authentication"><a href="#configure-the-app-for-authentication" class="header-anchor">#</a> Configure the app for authentication</h2> <p>There's a lot of detail to ensure that the OpenID Connect protocol specifications are followed properly. To help developers use OpenID Connect in their applications, Microsoft provides middleware to facilitate this communication. This middleware consists of APIs that include methods and properties that make it easy to interact with the identity provider.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CookiePolicyOptions<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>CheckConsentNeeded <span class="token operator">=</span> context <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>MinimumSameSitePolicy <span class="token operator">=</span> SameSiteMode<span class="token punctuation">.</span>None<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>AzureADDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddAzureAD</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> Configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">&quot;AzureAd&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OpenIdConnectOptions<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>AzureADDefaults<span class="token punctuation">.</span>OpenIdScheme<span class="token punctuation">,</span> options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> options<span class="token punctuation">.</span>Authority <span class="token operator">+</span> <span class="token string">&quot;/v2.0/&quot;</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>TokenValidationParameters<span class="token punctuation">.</span>ValidateIssuer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can use the authentication middleware to sign in users from one or more Azure AD tenants. The middleware is initialized in the <em>Startup.Auth.cs</em> file, by passing it the client ID of the application and the URL of the Azure AD tenant where the application is registered. The middleware then takes care of:</p> <ul><li>Downloading the Azure AD metadata.</li> <li>Processing OpenID Connect authentication responses.</li> <li>Integration with the session cookie.</li></ul> <blockquote><p>If you want to know more about authentication and authorization in ASP.NET Core, I recommend you to take a look at this other article I created about <a href="/en/blog/aspnet-core-jwt-bearer-authentication-authorization/">Token-based authentication and authorization (JWT Bearer) with ASP.NET Core</a>.</p></blockquote> <hr> <!----></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#oauth-2-0" title="OAuth 2.0">OAuth 2.0</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#openid-connect-oidc" title="OpenID Connect (OIDC)">OpenID Connect (OIDC)</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#implementations-of-openid-connect" title="Implementations of OpenID Connect">Implementations of OpenID Connect</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#key-concepts" title="Key concepts">Key concepts</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#openid-connect-authorization-code-flow" title="OpenID Connect Authorization Code Flow">OpenID Connect Authorization Code Flow</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#authorization-code-flow-with-pkce" title="Authorization Code Flow with PKCE">Authorization Code Flow with PKCE</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#implicit-flow" title="Implicit Flow">Implicit Flow</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#client-credentials-flow" title="Client Credentials Flow">Client Credentials Flow</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#connecting-authorization-server-users-and-the-application-users" title="Connecting authorization server users and the application users">Connecting authorization server users and the application users</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#secure-application-with-openid-connect-and-azure-ad" title="Secure application with OpenID Connect and Azure AD">Secure application with OpenID Connect and Azure AD</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#what-is-azure-active-directory" title="What is Azure Active Directory?">What is Azure Active Directory?</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#create-an-azure-ad-tenant" title="Create an Azure AD tenant">Create an Azure AD tenant</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#register-a-web-app" title="Register a web app">Register a web app</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#configure-the-app-for-authentication" title="Configure the app for authentication">Configure the app for authentication</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://x.com/RNeto" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-fdbf4940><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-fdbf4940></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/index.html" class="nav-link" data-v-fdbf4940>Rafael Neto © 2025</a></li></ul></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.ee019d85.js" defer></script><script src="/assets/js/4.35e6b205.js" defer></script><script src="/assets/js/1.801c1b6e.js" defer></script><script src="/assets/js/34.70cab748.js" defer></script>
  </body>
</html>
